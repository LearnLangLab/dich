<!-- Hay th√™m bookmarklet n√†y v√†o thanh d·∫•u trang c·ªßa tr√¨nh duy·ªát
  B∆∞·ªõc 1: T·∫°o m·ªôt d·∫•u trang m·ªõi
  B∆∞·ªõc 2: ƒê·∫∑t t√™n cho d·∫•u trang, v√≠ d·ª•: "D·ªãch nhanh"
  B∆∞·ªõc 3: Sao ch√©p v√† d√°n ƒëo·∫°n m√£ JavaScript sau v√†o tr∆∞·ªùng URL c·ªßa d·∫•u trang
  B∆∞·ªõc 4: L∆∞u d·∫•u trang
  javascript:(function(){document.addEventListener('keydown',function(e){if(e.key==="Enter"){var s=window.getSelection().toString().trim();if(!s){alert("Ch·ªçn m·ªôt ƒëo·∫°n vƒÉn tr∆∞·ªõc ƒë√£.");return;}var url="https://learnlanglab.github.io/dich/Dich.html#"+encodeURIComponent(s);var w=window.open(url,"_langlab","width=800,height=600");if(w)w.focus();e.preventDefault();}});})(); 
  
  B√¢y gi·ªù, khi b·∫°n ch·ªçn m·ªôt ƒëo·∫°n vƒÉn b·∫£n tr√™n b·∫•t k·ª≥ trang web n√†o v√† nh·∫•n ph√≠m Enter, trang d·ªãch s·∫Ω t·ª± ƒë·ªông m·ªü trong m·ªôt c·ª≠a s·ªï m·ªõi.
  L∆∞u √Ω: M·ªôt s·ªë tr√¨nh duy·ªát c√≥ th·ªÉ ch·∫∑n c·ª≠a s·ªï b·∫≠t l√™n, v√¨ v·∫≠y h√£y ƒë·∫£m b·∫£o r·∫±ng tr√¨nh duy·ªát c·ªßa b·∫°n cho ph√©p c·ª≠a s·ªï b·∫≠t l√™n t·ª´ trang web n√†y.
  Ho·∫∑c m·ªü trang n√†y v√† th√™m #vƒÉn_b·∫£n_ƒë∆∞·ª£c_ch·ªçn v√†o cu·ªëi URL (v√≠ d·ª•: https://learnlanglab.github.io/dich/Dich.html#ÊàëÁà±‰Ω†)
  -->

<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>D·ªãch</title>
  <script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pinyin-pro@3.18.2/dist/index.js"></script>
  <style>
    textarea { width: 95%; overflow: auto;}
    .result { border: 1px solid #ccc; padding: 10px; white-space: pre-wrap; margin-top: 0px; color: #003366; 
              font-size: 25px; resize: vertical; overflow: auto;}
    .error { color: red; font-weight: bold; }
    .speaker { cursor: pointer; margin-left: 8px; font-size: 22px; }
  </style>
</head>
<body>
  <h4 style="margin-bottom: 0;">Ph·ªìn Th·ªÉ:</h4>
  <textarea  class="result" id="input" placeholder="Nh·∫≠p ch·ªØ ph·ªìn th·ªÉ..."></textarea><br>
  <button title="ESC" onclick="convert()">D·ªãch</button>

  <h4 style="margin-bottom: 0; font-size: 18px;">
    Gi·∫£n Th·ªÉ:
    <span class="speaker" onclick="speakText()">üîä</span>
  </h4>
  <div class="result" id="simplified"></div>

  <div style="font-size: 18px;" class="result" id="pinyin"></div>

  <h4 style="margin-bottom: 0;">Ti·∫øng Vi·ªát:</h4>
  <div class="result" id="vietnamese"></div>

<script>
async function convert() {
  const txt = document.getElementById("input").value.trim();
  document.getElementById("simplified").innerText = "ƒêang x·ª≠ l√Ω...";
  document.getElementById("pinyin").innerText = "";
  document.getElementById("vietnamese").innerText = "";

  if (!txt) return;

  const converter = OpenCC.Converter({ from: 'twp', to: 'cn' });
  const smp = converter(txt);
  document.getElementById("simplified").innerHTML = smp;

  if (!window.pinyinPro || typeof pinyinPro.pinyin !== 'function') {
    document.getElementById("pinyin").innerText = "Kh√¥ng t·∫£i ƒë∆∞·ª£c pinyin-pro";
  } else {
    const py = pinyinPro.pinyin(smp, { toneType: 'symbol' });
    document.getElementById("pinyin").innerHTML = py;
  }

  const url = "https://translate.google.com/?sl=zh-CN&tl=vi&text=" + encodeURIComponent(smp);

  // D·ªãch sang ti·∫øng Vi·ªát qua MyMemory API
  try {
    const res = await fetch("https://api.mymemory.translated.net/get?q=" + encodeURIComponent(smp) + "&langpair=zh-CN|vi");
    const data = await res.json();
    if (data && data.responseData && data.responseData.translatedText) {
      document.getElementById("vietnamese").innerHTML = data.responseData.translatedText;
    } else {
      document.getElementById("vietnamese").innerHTML = "<span class='error'>‚ùå Kh√¥ng d·ªãch ƒë∆∞·ª£c sang ti·∫øng Vi·ªát.</span>";
    }
  } catch (e) {
    document.getElementById("vietnamese").innerHTML = "<span class='error'>‚ùå L·ªói k·∫øt n·ªëi khi d·ªãch ti·∫øng Vi·ªát.</span>";
  }
}

// ƒê·ªçc to ph·∫ßn Gi·∫£n Th·ªÉ
function speakText() {
  const text = document.getElementById("simplified").innerText.trim();
  if (!text) return;

  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = "zh-CN"; // ti·∫øng Trung (gi·∫£n th·ªÉ)
  speechSynthesis.cancel(); // d·ª´ng tr∆∞·ªõc ƒë√≥ (n·∫øu ƒëang ƒë·ªçc)
  speechSynthesis.speak(utterance);
}

// G·∫Øn ph√≠m ESC ƒë·ªÉ g·ªçi h√†m convert
document.addEventListener("keydown", function(event) {
  if (event.key === "Escape") {
    convert();
  }
});
// T·ª± ƒë·ªông d·ªãch n·∫øu c√≥ tham s·ªë q trong URL (khi d√πng bookmarklet n·∫øu qu√©t ch·ªçn t·ª´ v√† ch·ªçn v√†o bookmarklet th√¨ s·∫Ω c√≥ tham s·ªë q)
// d·ªãch t·ª´ ƒë∆∞·ª£c b√¥i
window.addEventListener("DOMContentLoaded", () => {
  const params = new URLSearchParams(window.location.search);
  const q = params.get("q");
  if (q) {
    document.getElementById("input").value = q;
    convert();
  }
});
// t·ª± ƒë·ªông d·ªãch khi ·∫•n b√¥i ƒëen v√† nh·∫•n enter
function autoTranslate() {
  const params = new URLSearchParams(window.location.search);
  const q = params.get("q");
  const hash = decodeURIComponent(location.hash.slice(1));

  let text = q || hash;
  if (text) {
    document.getElementById("input").value = text;
    convert();
  }
}
window.addEventListener("DOMContentLoaded", autoTranslate);

window.addEventListener("hashchange", autoTranslate);
</script>
</body>
</html>
